// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Tracks a member's degrees (BSc, MSc, PhD) and academic history.
model AcademicInfo {
  id             String  @id @default(cuid())
  degree         String // e.g. BSc, MSc, PhD
  field          String? // e.g. Bioinformatics, Chemistry
  institution    String? // e.g. Tel Aviv University
  graduationYear Int?

  /// Foreign key for the 1:M relationship back to the Member.
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
}

/// Standard NextAuth.js model.
/// Stores a login method (e.g., Google, GitHub) linked to a User.
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refreshToken      String? @db.Text // long tokens stored as Text
  accessToken       String? @db.Text
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String? @db.Text
  sessionState      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

/// Represents a short-term, time-based reservation ("scheduling") for a piece of equipment.
/// This model is the core of the equipment calendar.
model Booking {
  id        String   @id @default(cuid())
  startTime DateTime
  endTime   DateTime
  purpose   String?

  /// The specific piece of equipment being booked.
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  /// The member who made the booking.
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  /// Optional: The project this booking is for (for tracking/billing).
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  /// Optional: The event this booking is for.
  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([equipmentId])
  @@index([memberId])
  @@index([projectId])
  @@index([eventId])
  /// Composite index to quickly find conflicts for a specific piece of equipment in a time range.
  @@index([equipmentId, startTime, endTime])
}

/// An external researcher or person (not a lab member) associated with a project.
model Collaborator {
  id           String  @id @default(cuid())
  name         String
  organization String?

  /// M:N relation linking collaborators to the projects they work on.
  projects Project[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([name]) // For searching by collaborator name
}

/// A general-purpose file (e.g., CV, protocol, proposal) linked to a project or member.
model Document {
  id       String @id @default(cuid())
  filename String
  url      String // file path or URL to the uploaded document

  /// Optional: Link a document to a specific project.
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  /// Optional: Link a document to a specific member (e.g., their CV).
  memberId  String?
  member    Member?  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  /// Optional: Link a document to a protocol (e.g., PDF version of protocol).
  protocol  Protocol?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([projectId])
  @@index([memberId])
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
}

/// Tracks a physical piece of lab equipment.
/// This model has three distinct functions: Allocation, Scheduling, and Planning.
model Equipment {
  id           String          @id @default(cuid())
  name         String
  description  String?
  serialNumber String?         @unique
  status       EquipmentStatus @default(AVAILABLE)

  /// --- 1. ALLOCATION (Ownership) ---
  /// This is for long-term "Allocation" or "Ownership".
  /// e.g., A project-specific sequencer (projectId) or a personal laptop (memberId).
  /// If both are null, it's general lab pool equipment.
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  memberId  String?
  member    Member?  @relation(fields: [memberId], references: [id], onDelete: SetNull)

  /// --- 2. SCHEDULING (Reservations) ---
  /// This links to all short-term, time-based reservations for this item.
  bookings Booking[]

  /// --- 3. PLANNING (Event Needs) ---
  /// This M:N relation links to all Events that *require* this item (e.g., "Meeting needs projector").
  events Event[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([projectId])
  @@index([memberId])
  @@index([name]) // For searching by equipment name
}

/// A calendar event, like a lab meeting, training session, or conference.
model Event {
  id          String     @id @default(cuid())
  title       String
  description String?
  date        DateTime // event date/time (could also have start/end if needed)
  location    String?
  /// M:N relation for all members attending the event.
  attendees   Member[]
  /// M:N relation for all projects related to this event.
  projects    Project[]
  tasks       NoteTask[]
  expenses    Expense[]

  /// --- PLANNING (Items "needed" for this event) ---
  /// M:N relation listing all equipment *required* for this event (the "shopping list").
  equipments Equipment[]

  /// --- SCHEDULING (Reservations for this event) ---
  /// 1:M relation listing all *actual bookings* made for this event.
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title]) // For searching by event title
  @@index([date]) // For searching by event date. Critical for calendar views.
}

/// A single financial cost that can be billed to a project, grant, or event.
model Expense {
  id          String   @id @default(cuid())
  description String
  amount      Float
  date        DateTime @default(now())

  /// Optional: The project this expense is for.
  projectId String?
  project   Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  /// Optional: The grant funding this expense.
  grantId   String?
  grant     Grant?     @relation(fields: [grantId], references: [id], onDelete: SetNull)
  /// Optional: The event this expense is for (e.g., travel costs).
  eventId   String?
  event     Event?     @relation(fields: [eventId], references: [id], onDelete: SetNull)
  noteTasks NoteTask[]

  @@index([projectId])
  @@index([grantId])
  @@index([eventId])
}

/// Represents a funding source or grant that provides a budget for projects.
model Grant {
  id       String   @id @default(cuid())
  name     String
  budget   Float // total budget amount
  deadline DateTime // e.g. grant end date or deadline

  /// M:N relation for all projects funded by this grant.
  projects Project[]
  /// 1:M relation for all expenses charged to this grant.
  expenses Expense[]

  createdAt DateTime @default(now())
  noteTasks NoteTask[]

  @@index([name]) // For searching by grant name
}

/// A polymorphic model for a note or task.
/// It can be attached to (almost) any other entity in the database via optional foreign keys.
model NoteTask {
  id        String    @id @default(cuid())
  title     String?
  content   String // note or task description
  completed Boolean   @default(false)
  dueDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// --- Polymorphic Relations ---
  /// Only one of these foreign keys should be set for a single note/task.
  memberId       String?
  member         Member?       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  projectId      String?
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  grantId        String?
  grant          Grant?        @relation(fields: [grantId], references: [id], onDelete: Cascade)
  eventId        String?
  event          Event?        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  publicationId  String?
  publication    Publication?  @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  documentId     String?
  document       Document?     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  equipmentId    String?
  equipment      Equipment?    @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  collaboratorId String?
  collaborator   Collaborator? @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  expenseId      String?
  expense        Expense?      @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  protocolId     String?
  protocol       Protocol?     @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  // Indexes on all foreign keys for efficient lookups.
  @@index([memberId])
  @@index([projectId])
  @@index([grantId])
  @@index([eventId])
  @@index([publicationId])
  @@index([documentId])
  @@index([equipmentId])
  @@index([collaboratorId])
  @@index([expenseId])
  @@index([protocolId])
}

enum MemberRank {
  PROFESSOR
  PhD
  POSTDOC
  MSc
  BSc
  Mr
  Mrs
}

enum MemberStatus {
  ACTIVE
  ALUMNI
  INACTIVE
}

enum MemberRole {
  PI
  STUDENT
  LAB_MANAGER
  RESEARCHER
  ADVISOR
  INTERN
  CONTRACTOR
  GUEST
  ALUMNI
  OTHER
}

/// The core profile for a person in the lab (e.g., student, PI).
/// This model stores profile/HR data, separate from the auth User.
model Member {
  id           String         @id @default(cuid())
  name         String
  rank         MemberRank? // e.g. academic rank or title
  status       MemberStatus? // e.g. active, alumni, etc.
  role         MemberRole? // e.g. PI, Student, Lab Manager
  scholarship  Int?
  photoUrl     String? // URL to profile photo
  joinedDate   DateTime? // Date when member joined the lab (defaults to createdAt if not specified)
  /// 1:M relation for all academic degrees this member holds.
  academicInfo AcademicInfo[]

  /// --- ALLOCATION (Items I "own") ---
  /// 1:M relation for all equipment allocated to this member (e.g., their laptop).
  equipments Equipment[]

  /// --- SCHEDULING (My reservations) ---
  /// 1:M relation for all bookings made by this member.
  bookings Booking[]

  /// M:N relation for all projects this member is a part of.
  projects     Project[]     @relation("ProjectMembers")
  /// M:N relation for all publications this member has authored.
  publications Publication[]
  /// M:N relation for all events this member is attending.
  events       Event[]
  /// 1:M relation for all documents attached to this member (e.g., their CV).
  documents    Document[]
  /// 1:M relation for all protocols authored by this member.
  protocols    Protocol[]     @relation("ProtocolAuthor")
  /// 1:1 link to the authentication User account.
  user         User?         @relation(name: "MemberUser")

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([name]) // For searching by member name
}

/// The central hub of the CRM. Represents a single research project.
/// Most other models link back to this.
model Project {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime?
  endDate     DateTime?

  /// --- ALLOCATION (Items "owned" by this project) ---
  equipments Equipment[]

  /// --- SCHEDULING (Reservations for this project) ---
  bookings Booking[]

  /// M:N relation for all members working on this project.
  members       Member[]       @relation("ProjectMembers")
  /// M:N relation for all grants funding this project.
  grants        Grant[]
  /// M:N relation for all publications resulting from this project.
  publications  Publication[]
  /// M:N relation for all external collaborators on this project.
  collaborators Collaborator[]
  /// 1:M relation for all documents related to this project.
  documents     Document[]
  /// 1:M relation for all protocols related to this project.
  protocols     Protocol[]
  /// M:N relation for all events related to this project.
  events        Event[]
  /// 1:M relation for all expenses charged to this project.
  expenses      Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  noteTasks NoteTask[]

  @@index([title]) // For searching by project title
}

/// A lab protocol or standard operating procedure (SOP).
model Protocol {
  id           String   @id @default(cuid())
  title        String
  description  String?
  category     ProtocolCategory @default(GENERAL)
  version      String   @default("1.0")
  estimatedTime String?
  difficulty   ProtocolDifficulty @default(INTERMEDIATE)
  tags         String?  @db.Text // JSON array or comma-separated
  downloads    Int      @default(0)
  
  /// Optional: Link to the member who created/owns this protocol.
  authorId     String?
  author       Member?  @relation("ProtocolAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  
  /// Optional: Link to a project this protocol is associated with.
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  /// Optional: Link to a document (PDF, etc.) for this protocol.
  documentId   String?  @unique
  document     Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  
  /// Structured protocol data stored as JSON
  materials    String?  @db.Text // JSON array
  equipment    String?  @db.Text // JSON array
  steps        String?  @db.Text // JSON array of {step, instruction, time}
  safetyNotes  String?  @db.Text // JSON array
  versionHistory String? @db.Text // JSON array of {version, date, changes}

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([title]) // For searching by protocol title
  @@index([category])
  @@index([authorId])
  @@index([projectId])
}

enum ProtocolCategory {
  WET_LAB
  COMPUTATIONAL
  SAFETY
  GENERAL
}

enum ProtocolDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

/// An academic paper or article resulting from a project.
model Publication {
  id        String    @id @default(cuid())
  title     String
  published DateTime?
  /// Digital Object Identifier, should be unique.
  doi       String?   @unique
  url       String?
  /// M:N relation for all members who authored this paper.
  members   Member[]
  /// M:N relation for all projects this paper is associated with.
  projects  Project[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  noteTasks NoteTask[]

  @@index([title]) // For searching by publication title
}

/// Standard NextAuth.js model.
/// Stores an active user login session.
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Standard NextAuth.js model.
/// Represents the core authenticated user (the "login").
/// This is kept separate from the Member profile for security and flexibility.
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  image         String?

  /// 1:1 link to the corresponding Member profile.
  /// Nullable to allow User creation before Member profile is created during authentication.
  memberId String? @unique
  member   Member? @relation(name: "MemberUser", fields: [memberId], references: [id], onDelete: Cascade)

  /// 1:M link to all login methods (e.g., Google, GitHub).
  accounts Account[]
  /// 1:M link to all active login sessions.
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Standard NextAuth.js model.
/// Used for passwordless email sign-in links.
model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}